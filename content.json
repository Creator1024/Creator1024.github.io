{"meta":{"title":"oneWay","subtitle":null,"description":null,"author":"oneWay","url":"http://yoursite.com"},"pages":[{"title":"Categories","date":"2018-09-06T07:21:03.360Z","updated":"2018-05-21T04:42:07.588Z","comments":true,"path":"categories/index.html","permalink":"http://yoursite.com/categories/index.html","excerpt":"","text":""},{"title":"categories","date":"2018-05-19T15:52:42.000Z","updated":"2018-05-19T16:02:19.383Z","comments":true,"path":"category/index.html","permalink":"http://yoursite.com/category/index.html","excerpt":"","text":""},{"title":"About","date":"2018-09-06T07:21:03.360Z","updated":"2018-05-21T04:42:07.586Z","comments":true,"path":"about/index.html","permalink":"http://yoursite.com/about/index.html","excerpt":"","text":""},{"title":"Tags","date":"2018-09-06T07:21:03.360Z","updated":"2018-05-21T04:42:07.591Z","comments":true,"path":"tags/index.html","permalink":"http://yoursite.com/tags/index.html","excerpt":"","text":""}],"posts":[{"title":"DNS Tunnel","slug":"DNSTunnel","date":"2018-09-02T02:02:51.000Z","updated":"2018-09-23T02:13:12.586Z","comments":true,"path":"2018/09/02/DNSTunnel/","link":"","permalink":"http://yoursite.com/2018/09/02/DNSTunnel/","excerpt":"","text":"一.原理1.1.dns概述dns协议最基本的作用是将域名映射为ip地址，让我们在访问网页的时候无需记住复杂的ip地址。在一些地方，需要我们认证才能上网。假如我们没有认证，大部分的流量都会被过滤，但是往往都会放行dns流量，windows下可通过nslookup或者ping命令查看dns流量是否被过滤：1234567891011121314C:\\&gt;nslookup默认服务器: UnKnownAddress: 2001:250:6801:5501:2e0:4cff:fe51:c4&gt; baidu.com服务器: UnKnownAddress: 2001:250:6801:5501:2e0:4cff:fe51:c4非权威应答:名称: baidu.comAddresses: 123.125.115.110 //能够返回ip地址则说明dns流量没有被过滤 220.181.57.216C:\\&gt;ping baidu.com 正在 Ping baidu.com [220.181.57.216] 具有 32 字节的数据://如果没有认证，一般icmp流量也会被禁用，但是我们可以看到域名成功解析为ip地址，则dns流量没有被过滤。 如果放行了dns流量，就可以使用dns隧道免费上网。在我们学校，可以突破晚上十一点断网的限制，如果对网速没什么要求，连网费都可以不用交。 1.2.dns隧道原理 dns隧道工具将进入隧道的其他协议流量封装到dns协议内，在隧道上传输。这些数据包出隧道时进行解封装，还原数据。 在建立隧道之前，我们需要让dns隧道的客户端找到隧道的服务端，其过程大致如下：①本地主机A发送一条dns请求，查询一个我们设定好的域名。②因为沿途的dns服务器都没有这个域名的相关信息，最终这条请求被转发到权威域名服务器B（假如是腾讯云上注册的域名，腾讯的域名服务器就是针对你的域名的权威服务器）。③我们添加了一条NS记录，关于要查询的域名，需要转到我们的公务服务器C做解析，B就会把C的地址返回给A。④A知道了C的地址，就可以建立起dns隧道了。 二.实现步骤2.1.工具准备 一个域名 一台公网服务器，并且拥有公网地址。学生认证过的腾讯云或者阿里云上都可以买到10元/月的云服务器，域名也很便宜。学生优惠套餐腾讯云个人免费体验15天云服务器域名注册 dns隧道工具：这里使用iodine（拥有速度快、支持多平台等特点） 代理工具ssr、Proxifier，隧道搭建好之后，需要使用代理，让我们的应用程序走代理才能利用该隧道 2.2.添加域名解析我申请的域名是slickghost.coma.slickghost.com和b.slickghost.com都是子域名（三级域名）这里需要添加两条记录：123主机记录 记录类型 记录值b A 云主机公网IPa NS b.slickghost.com 两条记录组合的含义如下：当我们的主机去查询a.slickghost.com时，由于该域名对应的是一条NS记录，记录值是b.slickghost.com，此时，dns查询请求就会转发到b.slickghost.com这个域名服务器，而这个域名对应一条A记录，该记录值为云主机的公网地址，所以最终dns查询请求最会转发到我们的服务器。 2.3.安装iodineiodine（点击下载）是一个集成客户端和服务端的工具。这里使用的服务端为linux，客户端为windows，要下载两个版本。 2.3.1.iodine服务端服务器直接使用wget下载即可，如果有问题，可以先下载好压缩包再传到服务器上。1234wget https://code.kryo.se/iodine/iodine-0.7.0.tar.gz //下载iodinetar -zxvf iodine-0.7.0.tar.gz //解压cd iodine-0.7.0 //解压后进入该目录make install //安装 安装后之后就会出现一个bin目录，该目录下有两个iodine应用程序，iodine（客户端）和iodined（服务端）。12345678接着运行命令：./iodined -f -c -P Password123 192.168.0.1 a.slickghost.com &amp;参数说明：-f to keep running in foreground-c to disable check of client IP/port on each request -P password used for authentication (max 32 chars will be used)Password123就是客户端连接服务器时需要用到的密码 此时DNS隧道服务端就部署完成了，等待客户端的连接。可以使用iodine官方提供的工具测试服务端是否搭建成功：测试工具 2.3.1.iodine客户端客户端需要一个TAP网卡，下载一个六快拨或者openvpn，安装完之后就会多出一块网卡。六快拨下载地址 解压windows版iodine后在管理员模式下运行命令：1iodine -P Password123 -f 公网地址 a.slickghost.com 至此，DNS隧道就搭建完成了。这时候应该要能够ping通刚刚我们在服务器指定的IP：192.168.0.1。创建dns隧道客户端时，其与服务端协商，并自动帮我们配置好了TAP网卡的IP地址。刚刚ping的时候使用的就是这个虚拟网卡。 2.4.使用代理我们已经把dns隧道搭建好了。但是现在应用程序的流量没有被指定通过这个隧道来走，我们使用ssr全局代理+Proxifier来解决这个问题。 2.4.1.服务器安装ssr具体安装步骤参照：ssr搭建教程 2.4.2.客户端ssr设置网上下载一个ssr客户端，进行如下配置服务器ip是使用iodine创建隧道服务端时指定的ip。服务器端口是安装ssr服务端时指定的端口。将客户端ssr设置为全局代理之后，浏览器就可以绕过认证上网了。 2.4.2.Proxifier设置ssr只能让我们使用浏览器访问网页的时候绕过认证，其他的应用程序还是不能上网，我们需要用Proxifier将本地应用程序的流量转到ssr代理，从而能够利用dns隧道。 打开Proxifier之后，会自动检测可走ssr代理：点击确定后就会自动创建一个规则——直连到SSR若检测不到，我们可以手动创建：配置文件——代理规则——添加。这时候电脑所有的应用程序都通过Proxifier走ssr代理，而原来我们的浏览器已经走ssr代理了，导致冲突，需要再添加一条规则，让你用到的浏览器不需要通过Proxifier。我平时使用的是firefox 添加好以上两条规则之后，所有的应用程序就都可以上网了。登个tim，听听音乐，刷个网页啥还是没问题的。如果你的隧道服务器在香港或者国外，还可以过GFW。","categories":[{"name":"其他","slug":"其他","permalink":"http://yoursite.com/categories/其他/"}],"tags":[{"name":"DNS","slug":"DNS","permalink":"http://yoursite.com/tags/DNS/"}]},{"title":"DNS","slug":"DNS","date":"2018-09-01T02:01:51.000Z","updated":"2018-09-23T02:03:13.076Z","comments":true,"path":"2018/09/01/DNS/","link":"","permalink":"http://yoursite.com/2018/09/01/DNS/","excerpt":"","text":"一、作用现在互联网上绝大多数设备是基于TCP/IP协议，使用IP地址进行通信的。设备之间通信时必须要有一个IP地址。当我们需要访问一个网站时，相对于一个32bit的ip地址，我们更愿意记住一串更具标识性字符。而DNS协议最基本的作用便是把这串字符解析为相应的ip地址。 二、域名系统2.1.名称空间DNS中使用的所有的名称集合构成了DNS名称空间。与linux文件系统类似，这个名称空间是一个树形结构。树根的顶部未命名，最高层（一级域）是顶级域名.（TLD），如我们常见的.com，.net（gTLD）就是属于顶级域名。 一个域名包含一系列的由点隔开的标签，每个标签最多可到63个字符，标签使用“Punycode码”编码。2017年的时候国内的安全专家发现部分浏览器会受到Punycode钓鱼攻击的影响。 标签类型有两种：数据标签和压缩标签。 数据标签写法：[3]www[7]jianshu[3]com[0]——标签长度+字符，根标签长度为0。 压缩标签：当有多条其中一部分内容一样的记录时，压缩标签可以通过指向其他标签的指针以节省dns信息空间。比如说[3]usc[3]edu[0][4]ucla[192][4][0] ——设置标签内容之前的一个字节的2个高位为1（也就是192）来标识这是一个压缩标签，之后的14位（6+8）用来标识偏移量（本例中偏移量位4），则[192][4]就相当于edu。usc.edu和ucla.edu就共享了edu标签。 我们通常看到的域名都是完全限定域名（fully qualified domain name，FQDN）——主机名+全路径。 区域——一个区域是DNS名称空间的一棵子树，每一个域名都存在于某个区域中，TLD存在于根区域。123456www.slickghost.com 或者www.slickghost.com. 都是完全限定域名。www，slickghost，com这三个都称为标签，每个标签最多可以达到63个字符，比如说：thelongestdomainnameintheworldandthensomeandthensomemoreandmore.comwww是主机名，slickghost.com则是这台主机所存在的域。 2.2.缓存 域名服务器在学习域名的时候，也会缓存区域信息。使用缓存可以有效地减小网上的dns流量，也提高服务器的效率。 成功和不成功的解析（称为否定缓存，即该域名找不到对应的主机）都会被缓存。否定缓存在[RFC2308]中由可选变为强制。 Windows注册表HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\Dnscache\\Parameters控制缓存相关参数，maxcachettl为dns缓存最大TTL，dns回复中，每条记录也会有个TTL，二者取较小的值，一般都是用回复的TTL。12ipconfig /displaydns &gt; d:/dns.txt //查看本机dns缓存记录（因记录可能比较多，放在文件中查看比较合适 ）ipconfig /flushdns //清除dns缓存 Linux下/etc/nscd.conf控制是否使用本地文件、DNS协议，是否要缓存，缓存TTL等 三、DNS协议DNS协议由两个主要部分组成 对dns特定名称查询的查询/响应协议 dns服务器用于交换数据库记录的协议（区域传输）3.1.解析过程GW.HOME是本地DNS服务器，其使用ISP提供的DNS服务器做递归。现A.HOME查询EXAMPLE.COM最复杂的情况将经历以下11个步骤： A.HOME先查询本地hosts文件有没有EXAMPLE.COM的记录（0），若没有，则向GW.HOME发起dns查询请求（1），若GW.HOME不知道EXAMPLE.COM域或者COM TLD的名称服务器，他会转发查询到ISP提供的dns服务器（2）【称为递归】，假设该服务器也不知道请求的域和其他信息，则他就会联系根服务中的其中一台（3），因为根服务器不支持递归，他看到这是一个.COM域的请求，故返回需要联系的COM TLD的名称服务器信息（4）。ISP的dns服务器联系COM TLD服务器（5），其返回EXAMPLE.COM的名称服务器的域名和IP（6），这里是返回了A.IANA-SERVERS.NET，接着ISP的dns服务器联系他（7），其回复EXAMPLE.COM的相关信息（8），ISP的dns服务器将结果发送给GW.HOME（9），到这里，GW.HOME算完成了此次查询，可以将结果回送给A.HOME（10）。 3.2.消息格式3.2.1.消息段组成 消息段 含义 Header 头部（固定12Byte） Question 请求（一般为1） Answer 应答（一般至少为1） Authority 指向域的（授权）资源记录 Addiction 其他资源记录 Others 不同类型报文有不同的信息 3.2.2.头部字段组成 字段名 含义 Transation ID（事务ID） 客户端发出查询的时候随机生成，用来匹配响应和查询。 QR 0表示查询，1表示响应。 OpCode（操作码） 标准查询（0），通知（4），更新（5），1~3被弃用。 AA（authoritative answer，授权回答） 与缓存回答相对。 TC（truncated，可截断的） 表示当前应答总长度超过512个字节，只返回前512个字节。客户端收到TC位置1的回复，可能会发送基于TCP53端口的dns请求报文，以接受能够承载多于512字节的TCP数据，因为TCP能将消息分为多个报文段。 RD（recursion desired，期望递归） 告诉服务器执行递归查询。如果这个字段为0，而收到请求的服务器没有授权回答，则被请求的名称服务器就返回一个可以联系获取回答的其他名称服务器的列表。 RA（recursion available，递归可用） 如果服务器支持递归查询，则置该字段为1。TDL和gTDL一般不支持递归查询。 Z 保留，直接置0。 AD 如果信息已授权，则AD为真。 CD 如果禁用安全检查，则CD为真。 RCode（响应码） 通常为——没有差错（0），不存在域名（3），其他错误类型可查表 3.2.3.报文分析 这是一条dns查询请求报文，QR=0（查询），RD=1（期望递归），Questions=1（查询数为1） Queries中 ，有一条记录： 字段名 含义 Name 要查询的域名。 其标签数为3（实际上有4个，根标签的长度为0），域名长度为15（最大长度为255）。 Type 查询类型，常见的有：IPv4地址记录（A[RR类型]，1[值]）IPv6地址记录（AAAA，28） 名称服务器（NS，2）名称别名（CNAME，5）指针记录，IP映射为名称（PTR，12）邮件交换器（MX，15）文本，提供各种信息（TXT，16）查询开发特定服务的服务器信息（SRV，33）请求任意记录（ANY，255） Class（16bit） 查询类：互联网类（1）没有类（254）所有类（255） 这是一条dns响应报文，QR=1（响应），RD（期望递归）=1，RA（递归可用）=1。应答资源有3条，授权应答资源5条，其他应答资源2条。 四、常见DNS相关问题4.1.Anti-Spam by SPF垃圾邮件伪造发件人的地址，使其看起来像一个合法的地址（如银行、官方网站等），用以欺骗收件人透露账号密码、个人资料等相关信息。而SPF（Sender Policy Framework，发送方策略框架）则是一个解决垃圾邮件和防伪造的一个标准。 许多资料上说到，PTR记录也用作电子邮件的防伪，这确实是一种方法，国外有些邮件服务器有使用到，不过比较正式的还是使用SPF来处理。 4.1.1.SPF原理 SPF是一种DNS记录类型，它是一种TXT记录，其登记了某个域名拥有的用来外发邮件的所有（邮件）服务器。 SPF与MX记录相反，MX是用来记录某个域名的邮件服务器有哪些，而SPF则是表面哪些邮件服务器是经过某个域名认同可以发送邮件的。 假设一个MTA（Mail Transfer Agent）收到一条邮件，发送这条邮件的服务器IP是1.1.1.1，并声称发件人是xxx@example.com。 MTA会去查询example.com的SPF记录，该域的SPF记录允许1.1.1.1这个IP，则接受该邮件，否则视其为伪造邮件并退回。 4.1.2.SPF语法12345linux下可以使用“dig -t txt 域名”来查看某个域名的spf记录，如：dig -t txt qq.com;; ANSWER SECTION:qq.com. 1383 IN TXT &quot;v=spf1 include:spf.mail.qq.com -all&quot; 一条SPF记录可定义一个或多个机制（mechanism）。在每一个mechanism前都有一个限定符（qualifier）对其进行评估，这些限定符包括：123456789101112如果没有指定限定符，则默认为&quot;+&quot;&quot;+&quot; Pass（通过）：发送方主机允许从该域发送邮件。&quot;-&quot; Fail（拒绝）：发送方主机没有授权从该域发送邮件&quot;~&quot; Soft Fail（软拒绝）：软拒绝的处理结果取决于接收电子邮件的软件。&quot;?&quot; Neutral（中立）:SPF 记录中没有关于发件 IP 是否合法的信息,可接收邮件。当接收服务器处理SPF语句（使用check_host()函数）时，除了以上四种限定符所对应的状态外，还有三种状态，分别是：None：服务器没有设定 SPF 记录，可接收邮件。TempError：发生了临时错误，比如说DNS查询失败。PermError：SPF配置存在问题，通常是因为TXT记录或者SPF语句存在问题，没规定接收还是拒收邮件。 接下来看看SPF的几种机制并举例： all ：表示所有 IP。 12&quot;v=spf1 -all&quot; 拒绝所有，这样可以表示不会以该域名发送邮件&quot;v=spf1 +all&quot; 接受所有 ip4：格式为ip4:&lt;ip4地址&gt;或者ip4:&lt;ip4网络&gt;/&lt;掩码&gt;，用于指定一个 IPv4 地址或者地址段。如果掩码没有给出，则默认为/32。 1&quot;v=spf1 ip4:1.1.1.1 -all&quot; 只允许IP为1.1.1.1的主机 ip6：类似IPv4。 a：指定一个a记录所对应的IP地址（段），其格式为：12345aa/&lt;掩码&gt;a:&lt;域名&gt;a:&lt;域名&gt;/&lt;掩码&gt;如果没有指定域名，则默认为当前域名 例如：1234&quot;v=spf1 a -all&quot;允许当前域名的 a 记录对应的 IP 地址。&quot;v=spf1 a a:test.example.com -all&quot;允许当前域名的 a 记录以及test.example.com的a记录对应的 IP 地址。 mx：和a的格式及用法一样。 exists :格式为exists:。对执行一个 A记录查询，只要有返回结果，就看作命中。 include：格式为include：，标识引入的SPF记录和域名的SPF记录一样。 12&quot;v=spf1 include:example.com -all&quot; 采用和 example.com 一样的 SPF 记录 ptr ：格式为ptr或者ptr:。使用ptr机制会带来大量很大开销的 DNS 查询，官方不推荐使用。 redirect：格式为redirect=，表示使用域名的SPF记录替换该记录。不妨试试dig -t txt gmail.com 4.2.区域传输和DNS通知的用途由于dns查询量较大，一般会使用从dns服务器分段压力。区域传输用于主dns服务器和从dns服务器之间同步RR。刚开始，服务器一般使用完整的区域传输（AXFR消息），因为同步RR数据量比较大，所以通常使用TCP，传输前需建立TCP连接。在同步完成后，主服务器和从服务器共同维护一个序列号来判断当前数据库是否一致，主服务器更新了数据库之后就会增加序列号的值，从服务器定期发送自身的序列号，主服务器如果收到了较小序列号的查询，可以使用增量的区域传输（IXFR消息）让这台从服务器与自己同步。因为从服务器发送查询以确认序列号是否一致是有时间间隔的，所以加入了一种DNS NOTIFY消息（基于UDP）进行优化。主服务器数据库发生变化的时候，就会发送该消息，客户端接收到该消息之后进行回复，之后就可以开始同步了。 4.3.DNS劫持、污染 dns劫持指的是域名服务器返回错误的ip，让请求者访问域名服务器拥有者希望其访问的页面，比较常见的就是运营商的dns劫持，最典型的就是上网时一大堆的广告。可以通过指定一个固定的dns服务器来解决。 dns污染，或者称dns缓存投毒。因为dns查询/回复一般是基于不可靠无连接的udp协议，而且通常没有什么认证机制，所以很容易被篡改。对于dns污染，我们很难通过设置来解决。不过，修改本地hosts文件是一种办法。 4.4.SOA和NS记录 SOA记录称为起始授权记录，用来表明哪个服务器是权威服务器，或者说哪个服务器是这个区域的所有者。创建dns服务器只能创建一个标准区域，通常也会使用其他服务器创建辅助区域用于分担负载等作用。创建标准区域的那台服务器就是权威服务器，即SOA记录中的ip地址是这台服务器的地址。也只有标准区域可以对信息进行更改，辅助区域只能复制信息。 NS记录是名称服务器记录，或者说是别名记录，他指明了对于某个域名，该由谁来解析。网络上有一些缓存了大量dns记录的服务器，称为唯缓存dns服务器，通过别名记录让解析权转到这样的服务器，就能够让dns解析的速度变快。我们在域名提供商申请了一个域名之后，假设是example.com，该域名提供商的域名服务器会提供此域名比如www.example.com的解析。如果我们自己想搭建一台dns服务器用来解析，就可以用NS记录。","categories":[{"name":"数据通信","slug":"数据通信","permalink":"http://yoursite.com/categories/数据通信/"},{"name":"协议分析","slug":"数据通信/协议分析","permalink":"http://yoursite.com/categories/数据通信/协议分析/"}],"tags":[{"name":"DNS","slug":"DNS","permalink":"http://yoursite.com/tags/DNS/"}]},{"title":"IP","slug":"IP","date":"2018-06-02T07:11:59.000Z","updated":"2018-09-06T07:18:28.298Z","comments":true,"path":"2018/06/02/IP/","link":"","permalink":"http://yoursite.com/2018/06/02/IP/","excerpt":"","text":"1.IP头部组成 版本：IP协议的版本 0100——IPV4 0110——IPV6 首部长度：ip报文的首部长度，20-60字节 服务类型： 优先级用来区别优先级别不同的IP报文（PPP） D表示要求有更低的时延 T表示要求有更高的吞吐量 R表示要求有更高的可靠性 C标识要求有更小的费用 总长度：报文的长度（最大65535字节） 标识：数据报长度超过MTU（最大传输单元），就要进行分片，这个标识字段的值被复制到所有数据包分片的标识字段中，使得这些分片在达到最终目的地的时候可以按照标识字段的内容重新组成原来的完整数据报。 标志：最低位MF,MF=1时，表示后面还有分片，中间位为DF,DF=1时，表示不能分片。 片偏移：本分片在原先数据报文中相对于首位的偏移位。 生存时间：表示数据报在网络中存活的时间，所允许通过的路由器最大数量。每通过一个路由器，则TTL值减少1，当其值为0时，路由器就可以把该数据包丢弃。 协议：标识上层（传输层或者是其他封装）所使用的协议。常用的协议号： ICMP 1 IGMP 2 TCP 6 UDP 17 IGRP 88 OSPF 89 （IPv4-in-IPv4） 4 首部校验和：对IP头部做正确性检测，不包含数据部分校验方法：在发送端，将IP数据报首部划分为多个16位的二进制序列，并将首部校验和字段置为0，用反码运算将所有16位序列对位相加后，将得到多的和的反码写入首部校验和字段。接收端接收到数据报后，将数据报首部的所有字段组织成多个16位的二进制序列，再使用反码运算相加一次，将得到的结果取反。如果结果为0代表没出错，否则出错。——具体算法实现：（待补充） 源地址和目的地址：标识了IP包的起源和目的地址。除非使用NAT，否则传输过程这两个值不变 可选项：由起源设备根据需要添加改写。 填充：IP报头长度部分的单位为32bit，所以其长度必须为32bit的整数倍，若没达到，则会填充若干个0，达到32比特。 2.IP分片 R1#ping 23.1.1.3 size 2000，在R2的右侧接口分析流量，可以看到数据包被分片传输 第一个数据帧—— 总长度为1518字节： 以太网帧头14字节 SrcMAC，6字节 detMAC，6字节 Type，2字节 IP头部20字节 数据1480字节 IP头部Flags-MF置为1，表示还有更多的分片 第二个数据帧—— 总长度为534字节： 以太网帧头14字节 IP头部20字节 数据500字节 Fragment offset为1480，即表示此分组中的数据是从第1481个字节开始的，之前的分组已经传出了1480字节的数据（不包括IP头部） 两个分组的数据长度（不包括IP头）总和为1480+500=1980，第二个数据包内显示数据长度为1972字节。所以R1#ping 23.1.1.3 size 2000所发送数据具体的内容应为： IP头部20字节 ICMP头部8字节 ICMP数据1972字节 再来看看分片后的数据包大小（包括IP头）： 第一个数据包1500 第二个数据包520 二者总和2020字节，比原来多了20字节，即多出了一个没有填充的IP头部长度。","categories":[{"name":"数据通信","slug":"数据通信","permalink":"http://yoursite.com/categories/数据通信/"},{"name":"协议分析","slug":"数据通信/协议分析","permalink":"http://yoursite.com/categories/数据通信/协议分析/"}],"tags":[]},{"title":"ARP","slug":"ARP","date":"2018-06-01T12:42:46.000Z","updated":"2018-09-06T07:18:28.283Z","comments":true,"path":"2018/06/01/ARP/","link":"","permalink":"http://yoursite.com/2018/06/01/ARP/","excerpt":"","text":"1.作用 为什么主机需要有各自的ipv4地址和mac地址才能通信呢？ip属于网络层，mac地址属于数据链路层。通过沿ip传输的路径是逻辑路径，由路由设备根据路由表进行转发，而一条逻辑路径包括多个数据链路。沿独立的数据链路传播的时候，就需要用到一种数据链路标识，以太网中的mac地址就起到这样的作用。 通常，主机刚开始发送数据的时候知道对方的ip地址，而不知道对方的mac地址。这时候就需要用到arp协议获悉到目的主机的mac地址，成功获悉到后便能正常封装数据包，并发送出去。 2.报文结构 3.代理ARP 代理arp被路由器作为向主机表明自身可用的一种手段：当开启代理ARP的路由器接口收到一个arp请求后，会查看目的ip，是否能根据本地的路由表到达，若可到达，则将自身收到arp请求的接口的mac地址回复给请求节点，告诉其去往目的网络可往这里发送。若不可达，则无视。 3.1静态路由与代理arp R2的g0/2接口开启代理arp功能并有返回192.168.1.0/24的静态路由 当R1使用静态路由 ip route 10.1.1.0 255.255.255.0 g0/0pc0分别ping其他两台主机： R1的arp表： R2的g0/2口接口信息： 分析：PC0 ping PC1，R1转发数据包的时候，自身arp表中没有10.1.1.1地址对应的mac地址，于是发送一条arp广播请求，R2的g0/2接口收到arp请求，由于开启了代理arp，并且拥有到达目的网络的ip，所以将自己g0/2的mac地址回复给R1（请求者）。当PC0 ping PC2的时候，依然重复此步骤。故R1的arp表中，10.1.1.1与10.1.1.2所对应的mac地址都是R2的g0/2口的mac地址。（如果arp表中多个ip地址映射到单一的mac地址往往是开启了代理arp）使用跟出接口的静态路由，转发每一个报文都要发送arp查询，在MA网络中，如果ARP报文大量发送，易造成广播风暴。 若将R1的路由改为 ip route 10.1.1.0 255.255.255.0 12.1.1.2 R1转发数据包之前，会先发送arp请求查询下一跳（12.1.1.2）的mac地址，之后这条路径就无需每次都发送arp查询。 4.无故（Gratuitous） ARP主机偶尔会以自己的IPv4地址作为目标地址发送ARP请求，此为无故ARP，或称为免费ARP。其主要有两种作用： 用来检测网络中是否有ipv4地址冲突 用于通告一个新的数据链路标识符 将R1的ip地址先配置为192.168.1.1/24，再配置成192.168.1.3/24。 通过抓包分析可知：gratuitous arp是一个replay arp，操作码值为2，其发送者和接受者皆为自身。 路由器每次更改接口ip地址的时候，都会发送一个gratuitous arp来避免ip冲突。另外，windows和linux启动后都会发送无故arp。 若将R2的f0/0的ip地址也改为192.168.1.3,则会出现地址冲突错误。 如果不解决这个问题，路由器会继续一直发送gratuitous arp…… 5.反向ARP（RARP）RARP作用是将数据链路标识符映射为ipv4地址，早期的无盘工作站中会使用到。不过RARP在很大程度上被DHCP和BOOTP的扩展协议所替代，他们能提供更多的信息。","categories":[{"name":"数据通信","slug":"数据通信","permalink":"http://yoursite.com/categories/数据通信/"},{"name":"协议分析","slug":"数据通信/协议分析","permalink":"http://yoursite.com/categories/数据通信/协议分析/"}],"tags":[{"name":"ARP","slug":"ARP","permalink":"http://yoursite.com/tags/ARP/"}]},{"title":"LAN","slug":"LAN","date":"2018-05-29T14:54:48.000Z","updated":"2018-09-06T07:18:28.298Z","comments":true,"path":"2018/05/29/LAN/","link":"","permalink":"http://yoursite.com/2018/05/29/LAN/","excerpt":"","text":"1.LAN基础 局域网指的是有限区域内相对距离较短的计算机和其他组件的网络，主要包含了物理层和数据链路层，一般我们接触到的局域网都是以太网组成的。 以太网发展历程 1234567891011121314151617181920211973年： 以太网（Xerox公司）1980年： DIX 标准版（以太网II）【Digital Equipment Corp，Intel，Xerox】 1983年： 10 BASE-5 --&gt;10Mb/s 粗同轴电缆以太网(IEEE802.3) 1985年： 10 BASE-2 --&gt;10Mb/s 细同轴电缆以太网(IEEE802.3a) 1990年： 10 BASE-T --&gt;10Mb/s双绞线(TP)以太网（IEEE802.3i）【twisted-pair】 1993年： 10 BASE-F --&gt;10Mb/s光纤以太网（IEEE802.3j）【fiber】 1995年： 100 BASE-xx --&gt; 快速以太网：100Mb/s双绞线和光纤以太网（IEEE802.3u） 1998年： 1000 BASE-X --&gt;千兆光纤以太网（IEEE802.3z） 1999年： 1000 BASE-T --&gt;千兆双绞线以太网（IEEE802.3ab） 2002年 : 10G BASE-xx --&gt;10千兆光纤以太网（IEEE 802.3ae） 2006年 : 10G BASE-T --&gt;10千兆双绞线以太网(IEEE 802.3an) 以太网中的流量主要包括： 数据流量（用户发的流量，以太网） 控制流量（交换机之间交互的流量，IEEE802.3) 2.MAC地址 MAC地址组成（烧录地址） 24位（3字节）OUI【组织唯一标识符】+24位（3字节）厂商分配的网卡，接口。 Cisco设备：0000.0000.0000 Linux: 00:00:00:00:00:00 Windows: 00-00-00-00-00-00 查询设备mac地址信息3.帧格式 前导码和帧开始符无法在包嗅探程序中显示。这些信息会在OSI第1层被网卡处理掉，而不会传入嗅探程序采集数据的OSI第2层。也存在OSI物理层的嗅探工具以显示这些前导码和帧开始符，但这些设备大多昂贵，多用于检测硬件相关的故障。 以太网帧格式 发展历程 EthernetV1（1980），Xerox和DEC、Intel公司共同提出的标准 EthernetV2（1982），目前大部分的以太网帧都是使用这个类型 Type：标识上层协议（大于0x0600） 0x0800 ipv4 0x0806 arp 0x8100 IEEE802.1Q(dot1q) 0x86DD ipv6 0x8864 PPPoE 0x8847 MPLSLabel 以太网帧的长度区间为64-1518字节（6+6+2+4+[46/1500]） IEEE802.3帧格式 802.3帧的长度区间也是64-1518字节 发展历程 RAW802.3（Novell，1983）：只支持IPX/SPX，将EthernetV2中的Tpye改为Length，Novell私有 IEEE802.3/802.2 LLC（1985）：IEEE正式的802.3标准，由EthernetV2发展而来，将Tpye改为Length，并且只能封装一种上层服务，即LLC，LLC子层中（通过DSAP和SSAP）区分更上层的服务。 交换机发送BPDU使用802.3/LLC模式（DSAP和SSAP为0x42） 这里使用的Length字段，表示上层数据长度 IEEE802.3/802.2 SNAP（1985）：为了在802 LLC上支持更多的上层协议同时更好的支持IP协议而发布，扩展了LLC属性，增加了一个2Byte的协议类型域（PID）和3Byte的厂商标识符（OUI）。 VTP使用的是802.3/SNAP模式： 这里使用的是Tpye字段，表示上层所使用的协议 当Tpye/Length字段小于1500,十六进制0x05DC时，对应802.3/LLC帧，当其大于1536,十六进制0x0600时，对应的是802.3/SNAP帧（与EthernetV2兼容） LLC中DSAP和SSAP取值不同的时候，代表不同的802.3类型帧 当DSAP和SSAP都取特定值0xff时，802.3帧就变成了Netware-ETHERNET帧，用来承载NetWare（Novell的网络操作系统）类型的数据。 当DSAP和SSAP都取特定值0xaa时，802.3帧就变成了ETHERNET_SNAP帧。ETHERNET_SNAP帧可 以用于传输多种协议。（如上图VTP使用的帧类型） DTP——0x2004 VTP——0x2003 CDP——0x2000 DSAP和SSAP其他的取值均为IEEE802.3/LLC帧。（如BPDU使用的帧类型）","categories":[{"name":"数据通信","slug":"数据通信","permalink":"http://yoursite.com/categories/数据通信/"},{"name":"基本概念","slug":"数据通信/基本概念","permalink":"http://yoursite.com/categories/数据通信/基本概念/"}],"tags":[{"name":"reviewDay1","slug":"reviewDay1","permalink":"http://yoursite.com/tags/reviewDay1/"}]},{"title":"Q&A","slug":"Q-A","date":"2018-05-29T14:54:30.000Z","updated":"2018-09-06T07:18:28.298Z","comments":true,"path":"2018/05/29/Q-A/","link":"","permalink":"http://yoursite.com/2018/05/29/Q-A/","excerpt":"","text":"一、分层模型 网络通信为何要设计分层模型 1234计算机之间的通信需要规定协议。20世纪80年代之前，不同品牌的计算机一般都会运行厂商自己定义的一套协议，这就导致了不同品牌的计算机之间通信出现了问题。所以在1985年ISO定义了OSI参考模型，大家都遵守这些统一规定的协议就解决了不同计算机之间互联的问题。整个网络体系结构是十分复杂的，通过分层的方法，降低了其复杂度。层与层之间提供标准化的接口，降低耦合性，能够专注模块化地设计。 OSI参考模型和TCP/IP参考模型有什么区别 123456OSI参考模型有七层结构，TCP/IP参考模型简化了OSI参考模型，他只定义了4层将应用层，表示层，会话层统一为应用层保留传输层，Internet层对应网络层将数据链路层和物理层统一为网络接口层（也有分为5层的说法，即数据链路层和物理层依然保留，没有统一）OSI参考模型存在的作用是给人们一个设计网络体系的框架TCP/IP模型则是适用于工业生产，所以现在我们现实中使用的大部分都是它。 简述OSI参考每一层作用 1234567应用层：为应用程序提供接口。表示层：数据的压缩解压缩，编码与解码，加密解密。会话层：建立，管理和终止应用程序之间的会话。传输层：提供端到端之间的连接。网络层：提供逻辑寻址，将数据包送达目的地。数据链路层：错误检测，提供物理寻址。物理层：定义传输介质、规则。 二、IP协议 为什么IP包头要设置头部长度和整个包的长度两个字段？ 12因为IP头部中有填充字段，且其长度是不固定的，有了IP头部长度（包含填充字段的长度）和整个包的长度就可以得出数据是从什么位置开始的（总长度-头部长度） 三、交换基础 交换机之间要使用动态协商模式建立trunk的时候需要满足哪些条件 12341.封装类型（dot1q，ISL）需一致2.接口的模式（主动被动...）3.双方需在同一个VTP域内（两端的本征vlan不一致可以建立trunk，但是会一致报错） 简述VTP消息类型和作用 1234567891011121314151617181920211.汇总通告消息(0x01)：交换机默认每5min发送一条汇总通告消息，来通知临近的交换机当前VTP域名和修订版本号if（domain mismatch or configuration revision number &lt; itself ）则忽略这个数据包。else 发送通告请求消息。2.子集通告消息(0x02)：修改vlan信息之后，发送一条汇总信息，接着会发送多条子集通告消息，每条子集通告消息中都有多条vlan消息如果有比较多vlan信息，则会分为几条子集信息来发送。3.通告请求消息(0x03)：以下情况，交换机会发送VTP通告请求消息以请求相关配置信息：——交换机重启——VTP域名被修改——交换机收到一条VTP汇总通告消息后，且该消息的配置修订号高于自身4.join消息（0x04）：VTP的修剪机制依赖于这种消息（周期5s）。一旦交换机的某个端口与vlan相关联，就会发送一个join消息通知其他交换机，希望接收有关此vlan的相关配置信息。（开启vtp修剪的情况下就会发送此类型消息） 防止一台新加入的交换机VTP的configuration revision过高扰乱原来的VLAN信息，如何将其置0 121.修改VTP域名2.修改其mode为transparent再改回server或client Protect-port（保护端口）有什么作用？——保护端口和保护端口之间不能通信，非保护端口和保护端口之间才能通信 生成树有什么作用？——识别并防止二层环路 STP的端口角色中，哪些监听/转发BPDU，哪些转发/不转发流量？ 121.根端口和非指定端口监听BPDU，指定端口转发BPDU2.根端口和指定端口可以发生接收流量，非指定端口不会转发流量（不会将源MAC写入CAM表） 简述交换机的三种转发模式 STP优化：Portfast，uplinkfast，backbonefast各有什么作用？ 简述MSTP配置过程 简述vlan跳跃攻击及防御方法 简述MAC地址泛洪攻击的原理以及防御方法四、路由基础 简述路由器启动过程1231.路由器首先执行开机自检，检查相关硬件2.引导程序查找并加载IOS，默认加载flashMemory中的IOS（若无，接着查找TFTP，ROM）3.IOS软件查找NVRAM中的启动配置文件，并将其复制到RAM（即running-config），假如找不到，则发送广播寻找是否有TFTP服务器能提供，若无，则进入交互配置模式","categories":[{"name":"Q&A","slug":"Q-A","permalink":"http://yoursite.com/categories/Q-A/"},{"name":"数通基础","slug":"Q-A/数通基础","permalink":"http://yoursite.com/categories/Q-A/数通基础/"}],"tags":[{"name":"reviewDay1","slug":"reviewDay1","permalink":"http://yoursite.com/tags/reviewDay1/"}]},{"title":"Ipsec","slug":"Ipsec","date":"2018-05-25T14:25:18.000Z","updated":"2018-09-06T07:18:28.298Z","comments":true,"path":"2018/05/25/Ipsec/","link":"","permalink":"http://yoursite.com/2018/05/25/Ipsec/","excerpt":"","text":"1.配置基本信息123AR1和AR3都写入一条默认路由模拟到达外网[AR1]ip route-static 0.0.0.0 0.0.0.0 12.1.1.2[AR3]ip route-static 0.0.0.0 0.0.0.0 23.1.1.2 2.配置IPSec12345678910111213141516171819202122232425262728总部路由器（AR1）配置1.抓取内网流量[AR1]acl 3000[AR1-acl-adv-3000]rule 5 permit ip source 192.168.1.0 0.0.0.255 destination 192.168.2.0 0.0.0.2552.配置ike[AR1]ike proposal 1[AR1-ike-proposal-1]encryption-algorithm 3des-cbc[AR1-ike-proposal-1]authentication-algorithm md5[AR1-ike-proposal-1]quit[AR1]ike peer AR3 v1[AR1-ike-peer-AR3]pre-shared-key simple oneWay //设置协商密钥，隧道两端要一致[AR1-ike-peer-AR3]ike-proposal 1 //调用刚刚创建的ike[AR1-ike-peer-AR3]remote-address 23.1.1.3 3.配置IPSec[AR1]ipsec proposal 1[AR1-ipsec-proposal-1]transform ah[AR1]ipsec policy Test 10 isakmp[AR1-ipsec-policy-isakmp-Test-10]security acl 3000 //isakmp使用ike建立ipsec SA[AR1-ipsec-policy-isakmp-Test-10]ike-peer AR3[AR1-ipsec-policy-isakmp-Test-10]proposal 14.接口下调用ipsec policy[AR1-GigabitEthernet0/0/1]ipsec policy Test 123456789101112131415161718192021222324分部路由器（AR3）配置[AR3]acl 3000[AR3-acl-adv-3000]rule 5 permit ip source 192.168.2.0 0.0.0.255 destination 192.168.1.0 0.0.0.255[AR3]ike proposal 1[AR3-ike-proposal-1]encryption-algorithm 3des-cbc [AR3-ike-proposal-1]authentication-algorithm md5[AR3]ike peer AR1 v1[AR3-ike-peer-AR1]pre-shared-key simple oneWay[AR3-ike-peer-AR1]ike-proposal 1[AR3-ike-peer-AR1]remote-address 12.1.1.1[AR3]ipsec proposal 1[AR3-ipsec-proposal-1]transform ah[AR3]ipsec policy Test 10 isakmp [AR3-ipsec-policy-isakmp-Test-10]security acl 3000[AR3-ipsec-policy-isakmp-Test-10]ike-peer AR1[AR3-ipsec-policy-isakmp-Test-10]proposal 1[AR3-ipsec-policy-isakmp-Test-10]quit[AR3-GigabitEthernet0/0/0]ipsec policy Test 3.验证结果若配置错误，display不会出现以下信息： PC1成功ping通PC3： 参考资料","categories":[{"name":"数据通信","slug":"数据通信","permalink":"http://yoursite.com/categories/数据通信/"},{"name":"R&S配置","slug":"数据通信/R-S配置","permalink":"http://yoursite.com/categories/数据通信/R-S配置/"},{"name":"华为","slug":"数据通信/R-S配置/华为","permalink":"http://yoursite.com/categories/数据通信/R-S配置/华为/"}],"tags":[{"name":"huawei","slug":"huawei","permalink":"http://yoursite.com/tags/huawei/"},{"name":"IPSec","slug":"IPSec","permalink":"http://yoursite.com/tags/IPSec/"},{"name":"ospf","slug":"ospf","permalink":"http://yoursite.com/tags/ospf/"}]},{"title":"dhcp+ospf","slug":"dhcp+ospf","date":"2018-05-24T13:31:59.000Z","updated":"2018-09-06T07:18:28.298Z","comments":true,"path":"2018/05/24/dhcp+ospf/","link":"","permalink":"http://yoursite.com/2018/05/24/dhcp+ospf/","excerpt":"","text":"HUAWEI DHCP+OSPF TestR1: dhcp enable //全局下先开启DHCP功能 ip pool network1 gateway-list 192.168.1.1 network 192.168.1.0 mask 255.255.255.0 excluded-ip-address 192.168.1.2 //排除地址 dns-list 192.168.1.1 interface Ethernet0/0/0 ip address 192.168.1.1 255.255.255.0 dhcp select global//该接口收到DHCP报文后直接去DHCP服务器在全局配置的IP地址池中寻找一个可用的地址 interface Ethernet0/0/1 ip address 12.1.1.1 255.255.255.0 R2: dhcp enable dhcp server ping packet 10 timeout 100 //配置dhcp服务器分配某个ip之前先探测该ip是否已被网络中pc使用的功能，dhcp服务器会向该ip地址发10个包且每次100ms，无应答才会分配该ip地址给客户端 dhcp check dhcp-rate enable //开启dhcp的速率检测功能开关 dhcp check dhcp-rate 90 //检测收到dhcp请求包的速率最大为90个/s，默认100个/s，防止dhcp泛红攻击 ip pool network2 gateway-list 192.168.2.1 network 192.168.2.0 mask 255.255.255.0 dns-list 192.168.2.1 static-bind ip-address 192.168.2.10 mac-address 0001-1111-2222 //为固定mac分配固定ip interface Ethernet0/0/0 ip address 12.1.1.2 255.255.255.0 interface Ethernet0/0/1 ip address 23.1.1.2 255.255.255.0 dhcp select global R3： ehcp enable interface Ethernet0/0/0 ip address 23.1.1.3 255.255.255.0 interface Ethernet0/0/1 ip address 192.168.2.1 255.255.255.0 dhcp select relay //dhcp中继 dhcp relay server-ip 23.1.1.2 此时PC1可以动态获取到ip地址，而PC2不可以。因为R2没有到达192.168.2.1的路由，无法回应Offer报文配置OPSF： [R1] ospf 1 area 0.0.0.0 network 192.168.1.1 0.0.0.0 network 12.1.1.1 0.0.0.0 [R2] ospf 1 area 0.0.0.0 network 12.1.1.2 0.0.0.0 network 23.1.1.2 0.0.0.0 [R3] ospf 1 area 0.0.0.0 network 192.168.2.1 0.0.0.0 network 23.1.1.3 0.0.0.0","categories":[{"name":"数据通信","slug":"数据通信","permalink":"http://yoursite.com/categories/数据通信/"},{"name":"R&S配置","slug":"数据通信/R-S配置","permalink":"http://yoursite.com/categories/数据通信/R-S配置/"},{"name":"华为","slug":"数据通信/R-S配置/华为","permalink":"http://yoursite.com/categories/数据通信/R-S配置/华为/"}],"tags":[{"name":"huawei","slug":"huawei","permalink":"http://yoursite.com/tags/huawei/"},{"name":"ospf","slug":"ospf","permalink":"http://yoursite.com/tags/ospf/"},{"name":"dhcp","slug":"dhcp","permalink":"http://yoursite.com/tags/dhcp/"}]}]}